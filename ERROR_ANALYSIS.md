# Анализ ошибки индексации

## Ошибка
```
PageIndex indexing failed: unsupported operand type(s) for +: 'int' and 'NoneType'
```

## Причина
Ошибка возникала при попытке выполнить арифметические операции с `None` значениями в нескольких местах кода PageIndex.

## Исправленные места

### 1. `utils.py` - функция `post_processing` (строки 466-468)
**Проблема**: Попытка вычесть 1 из `None` или использовать `None` как индекс
```python
# БЫЛО (ошибка):
item['end_index'] = structure[i + 1]['physical_index']-1  # Если physical_index = None
```

**Исправлено**: Добавлена проверка на `None` перед операциями

### 2. `page_index.py` - функция `process_large_node_recursively` (строки 1007, 1010)
**Проблема**: Попытка использовать `None` как `start_index`
```python
# БЫЛО (ошибка):
node['end_index'] = valid_node_toc_items[1]['start_index']  # Если start_index = None
```

**Исправлено**: Добавлена проверка на `None` перед присваиванием

### 3. `page_index.py` - функция `add_page_offset_to_toc_json` (строка 411)
**Проблема**: Попытка сложить `None` с числом, если `offset = None`
```python
# БЫЛО (ошибка):
data[i]['physical_index'] = data[i]['page'] + offset  # Если offset = None
```

**Исправлено**: Добавлена проверка на `None` в начале функции

## Статус исправлений
✅ Все исправления применены
✅ Линтер не нашел ошибок
✅ Код защищен от операций с `None`

## Что делать дальше

1. **Перезапустить индексацию документов 5 и 6:**
   ```bash
   cd backend
   python fix_indexing.py
   ```

2. **Или удалить документы и загрузить заново** через API

3. **Мониторить логи** на наличие других ошибок

## Ожидаемый результат
После исправлений индексация должна пройти без ошибки `int + NoneType`.

